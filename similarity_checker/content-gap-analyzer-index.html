<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Gap Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #EF4A25;
            --primary-light: #ff6b47;
            --primary-rgba: 239, 74, 37;
            --bg-gradient: linear-gradient(135deg, #ffdbcc 0%, #ffe4dc 100%);
            --header-gradient: linear-gradient(135deg, #EF4A25 0%, #ff6b47 100%);
            --button-gradient: linear-gradient(135deg, #EF4A25 0%, #ff6b47 100%);
            --keyword-gradient: linear-gradient(135deg, #EF4A25 0%, #ff6b47 100%);
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --shadow-hover: 0 20px 40px rgba(0,0,0,0.15);
            --secondary-color: #6c757d;
            --secondary-rgba: 108, 117, 125;
            --accent-color: #FF6B35;
            --accent-light: #FF8A65;
        }
        
        .froala-theme {
            --primary-color: #0098F7;
            --primary-light: #33aaff;
            --primary-rgba: 0, 152, 247;
            --bg-gradient: linear-gradient(135deg, #cce7ff 0%, #e6f3ff 100%);
            --header-gradient: linear-gradient(135deg, #0098F7 0%, #33aaff 100%);
            --button-gradient: linear-gradient(135deg, #0098F7 0%, #33aaff 100%);
            --keyword-gradient: linear-gradient(135deg, #0098F7 0%, #33aaff 100%);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            transition: background 0.3s ease;
        }
        
        .container {
            width: 100%;
            max-width: none;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
        }
        
        .header {
            background: var(--header-gradient);
            color: white;
            padding: 30px 40px;
            text-align: center;
            transition: background 0.3s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 0;
            width: 100%;
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 0;
            min-height: calc(100vh - 120px);
            position: relative;
            overflow: hidden;
        }
        
        .config-section {
            position: sticky;
            top: 0;
            height: calc(100vh - 120px);
            background: white;
            backdrop-filter: none;
            border-radius: 0;
            padding: 40px 30px;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            border: none;
            border-right: 1px solid #e1e8ed;
            overflow-y: auto;
            grid-column: 1;
            z-index: 10;
        }
        
        .results-section {
            overflow-y: auto;
            height: calc(100vh - 120px);
            padding: 40px;
            background: #f8f9fa;
            grid-column: 2;
        }
        
        .results-section::-webkit-scrollbar {
            width: 8px;
        }
        
        .results-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .results-section::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        
        .results-section::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-rgba), 0.2);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-direction: column;
        }
        
        .btn {
            padding: 15px 30px;
            border: 2px solid transparent;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: var(--button-gradient);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 4px 15px rgba(var(--primary-rgba), 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(var(--primary-rgba), 0.5);
            border-color: var(--primary-light);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(var(--primary-rgba), 0.2);
        }
        
        .btn-secondary {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            border-color: #5a6268;
            transform: translateY(-2px);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: var(--primary-color);
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            display: none;
            animation: slideIn 0.5s ease-out;
        }
        
        .results.show {
            display: block;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--primary-color);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            display: block;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #6c757d;
            font-weight: 600;
        }
        
        .gap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .gap-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .gap-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .gap-card.high-priority {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
        }
        
        .gap-card.medium-priority {
            border-left-color: var(--accent-color);
            background: linear-gradient(135deg, #fff8f5 0%, #ffffff 100%);
        }
        
        .gap-card.low-priority {
            border-left-color: var(--primary-color);
            background: linear-gradient(135deg, #f8fff9 0%, #ffffff 100%);
        }
        
        .gap-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            line-height: 1.3;
        }
        
        .gap-metadata {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .metadata-tag {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .priority-high {
            background: #dc3545;
            color: white;
        }
        
        .priority-medium {
            background: var(--accent-color);
            color: white;
        }
        
        .priority-low {
            background: var(--primary-color);
            color: white;
        }
        
        .category-tag {
            background: var(--primary-color);
            color: white;
        }
        
        .content-type {
            background: #6c757d;
            color: white;
        }
        
        .gap-description {
            color: #6c757d;
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        
        .gap-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
            border-radius: 8px;
        }
        
        .filter-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .opportunity-score {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .error {
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            color: #c62828;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid #ffcdd2;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        /* Source Selection Styles */
        .source-selection {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 10px;
        }
        
        .radio-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            border: 3px solid #e1e8ed;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            position: relative;
            overflow: hidden;
            flex: 1;
        }
        
        .radio-group::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(var(--primary-rgba), 0.05), transparent);
            transition: left 0.5s ease;
        }
        
        .radio-group:hover::before {
            left: 100%;
        }
        
        .radio-group:hover {
            border-color: var(--primary-color);
            background: rgba(var(--primary-rgba), 0.08);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--primary-rgba), 0.15);
        }
        
        .radio-group input[type="radio"] {
            margin: 0;
            transform: scale(1.2);
            accent-color: var(--primary-color);
        }
        
        .radio-group.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(var(--primary-rgba), 0.15) 0%, rgba(var(--primary-rgba), 0.08) 100%);
            box-shadow: 0 4px 15px rgba(var(--primary-rgba), 0.2);
            transform: translateY(-1px);
        }
        
        .radio-group label {
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
            user-select: none;
        }
        
        /* GPT Analysis Styles */
        .gpt-analysis {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(var(--primary-rgba), 0.05) 0%, rgba(var(--primary-rgba), 0.02) 100%);
            border: 1px solid rgba(var(--primary-rgba), 0.1);
            border-radius: 12px;
        }
        
        .gpt-analysis h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .analysis-content {
            display: none;
            color: #555;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        
        .analysis-content strong {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .toggle-analysis {
            margin-top: 15px;
            background: var(--primary-color) !important;
            color: white !important;
            border: none !important;
        }
        
        .toggle-analysis:hover {
            background: var(--primary-light) !important;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .config-section {
                position: static;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #e1e8ed;
                grid-column: 1;
            }
            
            .results-section {
                height: auto;
                overflow-y: visible;
                padding: 20px;
                grid-column: 1;
            }
            
            .gap-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Content Gap Analyzer</h1>
            <p>Discover untapped content opportunities using AI-powered topic analysis</p>
        </div>
        
        <div class="main-content">
            <div class="config-section">
                <div class="form-group">
                    <label>⚙️ Analysis Configuration</label>
                </div>
                
                <div class="form-group">
                    <label>🎯 Check against which blog source:</label>
                    <div class="source-selection">
                        <div class="radio-group selected" onclick="selectSource('filestack')">
                            <input type="radio" id="filestack" name="source" value="filestack" checked>
                            <label for="filestack">📚 Filestack Blogs</label>
                        </div>
                        <div class="radio-group" onclick="selectSource('froala')">
                            <input type="radio" id="froala" name="source" value="froala">
                            <label for="froala">✨ Froala Blogs</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>💡 Manual Topic Input</label>
                    <textarea 
                        id="manualTopics" 
                        placeholder="Enter your own topic ideas to check for gaps, one per line:

Examples:
top 5 WYSIWYG editors
best file upload libraries for React
WYSIWYG editor performance comparison
secure file upload best practices
rich text editor accessibility features

Leave empty to use auto-generated topics from our taxonomy."
                        style="min-height: 120px; font-family: inherit; resize: vertical;"
                        oninput="updateTopicCount()"
                    ></textarea>
                    <div id="topicCount" style="font-size: 12px; color: #666; margin-top: 5px;">0 custom topics</div>
                </div>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label for="analysisDepth">📊 Analysis Depth</label>
                        <select id="analysisDepth">
                            <option value="quick">Quick Scan (Top 50 gaps)</option>
                            <option value="standard" selected>Standard (Top 200 gaps)</option>
                            <option value="comprehensive">Comprehensive (Top 500 gaps)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="contentFocus">📝 Content Focus</label>
                        <select id="contentFocus">
                            <option value="all" selected>All Content Types</option>
                            <option value="technical">Technical Guides</option>
                            <option value="business">Business Applications</option>
                            <option value="tutorials">How-To Tutorials</option>
                            <option value="comparisons">Product Comparisons</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="industryFocus">🏢 Industry Focus</label>
                        <select id="industryFocus">
                            <option value="all" selected>All Industries</option>
                            <option value="saas">SaaS & Software</option>
                            <option value="ecommerce">E-commerce</option>
                            <option value="publishing">Publishing & Media</option>
                            <option value="education">Education & Learning</option>
                            <option value="enterprise">Enterprise Solutions</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="minSimilarity">📏 Gap Threshold</label>
                        <select id="minSimilarity">
                            <option value="0.2">20% (Very sensitive - find micro-gaps)</option>
                            <option value="0.3" selected>30% (Balanced gap detection)</option>
                            <option value="0.4">40% (Only significant gaps)</option>
                        </select>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="startGapAnalysis()">
                        🚀 Start Gap Analysis
                    </button>
                    <button class="btn btn-secondary" onclick="loadSampleData()">
                        📊 Load Sample Data
                    </button>
                    <button class="btn btn-secondary" onclick="exportResults()">
                        📤 Export Results
                    </button>
                </div>
                
                <div id="error" class="error"></div>
                
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <h3>Analyzing Content Gaps...</h3>
                    <p id="loadingStatus">Initializing analysis...</p>
                </div>
            </div>
            
            <div class="results-section">
                <div id="results" class="results">
                    <!-- Stats Overview -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-number" id="totalGaps">0</span>
                            <span class="stat-label">Content Gaps Found</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="highPriorityGaps">0</span>
                            <span class="stat-label">High Priority</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="avgOpportunity">0</span>
                            <span class="stat-label">Avg Opportunity Score</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="totalCategories">0</span>
                            <span class="stat-label">Categories Analyzed</span>
                        </div>
                    </div>

                    <!-- Filter Section -->
                    <div class="filter-section" id="filterSection" style="display: none;">
                        <h4>🔍 Filter Gaps</h4>
                        <div class="filter-grid">
                            <div class="form-group">
                                <label for="priorityFilter">Priority Level</label>
                                <select id="priorityFilter" onchange="filterResults()">
                                    <option value="all">All Priorities</option>
                                    <option value="high">High Priority Only</option>
                                    <option value="medium">Medium Priority Only</option>
                                    <option value="low">Low Priority Only</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="categoryFilter">Category</label>
                                <select id="categoryFilter" onchange="filterResults()">
                                    <option value="all">All Categories</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="typeFilter">Content Type</label>
                                <select id="typeFilter" onchange="filterResults()">
                                    <option value="all">All Types</option>
                                    <option value="guide">Guides</option>
                                    <option value="tutorial">Tutorials</option>
                                    <option value="comparison">Comparisons</option>
                                    <option value="list">Lists</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Gap Results -->
                    <div class="gap-grid" id="gapResults">
                        <!-- Gap cards will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * Content Gap Analyzer - Frontend JavaScript
         * Discovers untapped content opportunities using AI-powered topic analysis
         * Integrates with existing Apps Script environment variables
         */

        // Content Topic Taxonomy - Froala & Filestack Focus
        const CONTENT_TAXONOMY = {
            // Rich Text Editor Topics
            rich_text_editors: [
                "WYSIWYG editor", "rich text editor", "HTML editor", "visual editor",
                "text editor", "content editor", "inline editing", "collaborative editing",
                "real-time editing", "markdown editor", "code editor", "syntax highlighting",
                "editor customization", "editor plugins", "editor themes", "editor API",
                "editor integration", "mobile editing", "responsive editor", "accessibility editor"
            ],
            
            // File Management & Upload Topics
            file_management: [
                "file upload", "file picker", "drag and drop upload", "bulk upload",
                "image upload", "video upload", "document upload", "file processing",
                "image processing", "file transformation", "image optimization", "file compression",
                "thumbnail generation", "file validation", "upload progress", "chunked upload",
                "resumable upload", "cloud storage", "CDN integration", "asset management"
            ],
            
            // Web Development Integration
            web_development: [
                "JavaScript integration", "React components", "Vue.js integration", "Angular integration",
                "API integration", "SDK implementation", "plugin development", "custom integration",
                "responsive design", "mobile optimization", "cross-browser compatibility",
                "performance optimization", "lazy loading", "progressive loading", "bundling",
                "webpack integration", "build tools", "deployment", "hosting solutions"
            ],
            
            // CMS & Platform Integration  
            cms_platforms: [
                "WordPress integration", "Drupal integration", "Joomla integration",
                "headless CMS", "content management", "blog platforms", "e-commerce integration",
                "Shopify integration", "Magento integration", "custom CMS", "publishing platforms",
                "editorial workflow", "content approval", "version control", "content scheduling"
            ],
            
            // Developer Tools & Resources
            developer_tools: [
                "developer documentation", "API reference", "code examples", "tutorials",
                "getting started guide", "best practices", "troubleshooting", "debugging",
                "testing", "unit testing", "integration testing", "performance testing",
                "security testing", "code quality", "linting", "formatting", "documentation"
            ],
            
            // User Experience & Design
            user_experience: [
                "user interface design", "user experience", "usability testing", "accessibility",
                "responsive design", "mobile-first design", "touch interfaces", "keyboard navigation",
                "screen reader compatibility", "internationalization", "localization",
                "design systems", "component libraries", "style guides", "branding"
            ],
            
            // Business Applications & Use Cases
            business_applications: [
                "content marketing", "blogging", "e-commerce", "digital publishing",
                "document management", "collaboration tools", "productivity tools",
                "enterprise software", "SaaS applications", "customer portals",
                "admin dashboards", "reporting tools", "analytics", "metrics", "ROI"
            ],
            
            // Technical Implementation
            technical_implementation: [
                "performance optimization", "security", "data protection", "GDPR compliance",
                "scalability", "load balancing", "caching", "database optimization",
                "server configuration", "cloud deployment", "containerization", "microservices",
                "monitoring", "logging", "error handling", "backup solutions"
            ]
        };

        const CONTENT_ASPECTS = {
            // Performance & Technical
            performance: [
                "loading performance", "upload speed", "processing speed", "optimization",
                "caching", "compression", "lazy loading", "progressive loading",
                "memory usage", "CPU usage", "bandwidth", "scalability"
            ],
            
            // Security & Privacy
            security: [
                "security features", "data protection", "privacy", "encryption",
                "access control", "authentication", "authorization", "GDPR compliance",
                "data retention", "secure upload", "virus scanning", "malware protection"
            ],
            
            // Integration & Compatibility
            integration: [
                "API integration", "SDK", "plugin system", "third-party integration",
                "framework compatibility", "browser compatibility", "mobile compatibility",
                "cross-platform", "interoperability", "data export", "data import"
            ],
            
            // User Experience
            user_experience: [
                "ease of use", "user interface", "accessibility", "mobile experience",
                "responsive design", "touch support", "keyboard navigation",
                "customization", "personalization", "user preferences", "settings"
            ],
            
            // Features & Functionality
            features: [
                "core features", "advanced features", "customization options", "configuration",
                "workflow automation", "batch processing", "bulk operations",
                "collaboration", "sharing", "permissions", "version control"
            ],
            
            // Business Value
            business_value: [
                "cost savings", "time savings", "productivity", "efficiency",
                "ROI", "business benefits", "use cases", "success stories",
                "case studies", "implementation", "adoption", "migration"
            ]
        };

        // Global variables
        let analysisResults = [];
        let currentConfig = {};

        /**
         * Initialize the application
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved configuration
            loadSavedConfig();
        });

        /**
         * Load saved configuration from localStorage
         */
        function loadSavedConfig() {
            const saved = localStorage.getItem('contentGapConfig');
            if (saved) {
                const config = JSON.parse(saved);
                const source = config.source || 'filestack';
                
                // Set radio button selection
                document.getElementById('filestack').checked = (source === 'filestack');
                document.getElementById('froala').checked = (source === 'froala');
                
                // Update visual selection
                document.querySelectorAll('.radio-group').forEach(group => {
                    group.classList.remove('selected');
                });
                
                if (source === 'froala') {
                    document.querySelector('.radio-group:nth-child(2)').classList.add('selected');
                } else {
                    document.querySelector('.radio-group:nth-child(1)').classList.add('selected');
                }
                
                document.getElementById('analysisDepth').value = config.analysisDepth || 'standard';
                document.getElementById('contentFocus').value = config.contentFocus || 'all';
                document.getElementById('industryFocus').value = config.industryFocus || 'all';
                document.getElementById('minSimilarity').value = config.minSimilarity || '0.3';
                
                // Update theme
                updateTheme(source);
            }
        }

        /**
         * Save current configuration to localStorage
         */
        function saveCurrentConfig() {
            const source = document.querySelector('input[name="source"]:checked')?.value || 'filestack';
            const config = {
                source: source,
                collection: source === 'froala' ? 'froala_blogs' : 'filestack_blogs',
                analysisDepth: document.getElementById('analysisDepth').value,
                contentFocus: document.getElementById('contentFocus').value,
                industryFocus: document.getElementById('industryFocus').value,
                minSimilarity: document.getElementById('minSimilarity').value
            };
            localStorage.setItem('contentGapConfig', JSON.stringify(config));
            return config;
        }

        /**
         * Handle source selection
         */
        function selectSource(source) {
            // Update radio buttons
            document.getElementById('filestack').checked = (source === 'filestack');
            document.getElementById('froala').checked = (source === 'froala');
            
            // Update visual selection
            document.querySelectorAll('.radio-group').forEach(group => {
                group.classList.remove('selected');
            });
            event.target.closest('.radio-group').classList.add('selected');
            
            // Update theme based on source
            updateTheme(source);
        }

        /**
         * Update theme colors based on selected source
         */
        function updateTheme(source) {
            const body = document.body;
            if (source === 'froala') {
                body.classList.add('froala-theme');
            } else {
                body.classList.remove('froala-theme');
            }
        }

        /**
         * Update topic count display
         */
        function updateTopicCount() {
            const text = document.getElementById('manualTopics').value;
            const topics = text.split('\n').filter(line => line.trim().length > 0);
            document.getElementById('topicCount').textContent = `${topics.length} custom topics`;
        }

        /**
         * Generate content combinations based on taxonomy or manual input
         */
        function generateContentCombinations(config) {
            const combinations = [];
            const limits = {
                quick: 50,
                standard: 200,
                comprehensive: 500
            };
            
            const limit = limits[config.analysisDepth] || 200;
            
            // Check for manual topics first
            const manualTopicsText = document.getElementById('manualTopics').value.trim();
            if (manualTopicsText) {
                // Use manual topics
                const manualTopics = manualTopicsText
                    .split('\n')
                    .filter(line => line.trim().length > 0)
                    .map(line => line.trim())
                    .slice(0, limit); // Respect the limit
                
                manualTopics.forEach((topic, index) => {
                    combinations.push({
                        topic: topic,
                        aspect: 'manual input',
                        searchQuery: topic,
                        category: 'manual_topics',
                        aspectCategory: 'user_defined',
                        contentType: determineContentTypeFromTopic(topic),
                        priority: calculateManualTopicPriority(topic, index, config)
                    });
                });
                
                return combinations; // Return manual topics without sorting (preserve user order)
            }
            
            // Use auto-generated topics if no manual input
            let count = 0;
            for (const [categoryName, topics] of Object.entries(CONTENT_TAXONOMY)) {
                if (count >= limit) break;
                
                for (const topic of topics.slice(0, 20)) { // Limit topics per category
                    if (count >= limit) break;

                    for (const [aspectName, aspects] of Object.entries(CONTENT_ASPECTS)) {
                        if (count >= limit) break;

                        for (const aspect of aspects.slice(0, 3)) { // Top 3 aspects per topic
                            if (count >= limit) break;

                            const searchQuery = `${topic} ${aspect}`;
                            const contentType = determineContentType(topic, aspect);
                            
                            combinations.push({
                                topic,
                                aspect,
                                searchQuery,
                                category: categoryName,
                                aspectCategory: aspectName,
                                contentType,
                                priority: calculatePriority(topic, aspect, categoryName, config)
                            });
                            count++;
                        }
                    }
                }
            }

            // Sort by priority (high to low) for auto-generated topics
            return combinations.sort((a, b) => b.priority - a.priority);
        }

        /**
         * Determine content type based on topic and aspect
         */
        function determineContentType(topic, aspect) {
            if (aspect.includes('tutorial') || aspect.includes('guide')) return 'tutorial';
            if (aspect.includes('comparison') || aspect.includes('vs')) return 'comparison';
            if (aspect.includes('list') || aspect.includes('best')) return 'list';
            if (topic.includes('API') || topic.includes('integration')) return 'guide';
            return 'guide';
        }

        /**
         * Calculate priority score for combinations
         */
        function calculatePriority(topic, aspect, category, config) {
            let priority = 50; // Base priority

            // High-value topics
            const highValueTopics = [
                'WYSIWYG editor', 'rich text editor', 'file upload', 'image upload',
                'API integration', 'React', 'Vue', 'Angular', 'performance'
            ];
            
            if (highValueTopics.some(hvt => topic.toLowerCase().includes(hvt.toLowerCase()))) {
                priority += 25;
            }

            // High-value aspects
            const highValueAspects = [
                'performance', 'security', 'integration', 'optimization', 'best practices'
            ];
            
            if (highValueAspects.some(hva => aspect.toLowerCase().includes(hva.toLowerCase()))) {
                priority += 20;
            }

            // Category-based scoring
            const categoryScores = {
                rich_text_editors: 20,
                file_management: 18,
                web_development: 15,
                cms_platforms: 12,
                developer_tools: 10,
                user_experience: 8,
                business_applications: 6,
                technical_implementation: 15
            };
            
            priority += categoryScores[category] || 5;

            // Industry focus adjustment
            if (config.industryFocus !== 'all') {
                // Boost relevant content
                priority += 10;
            }

            return Math.min(priority, 100); // Cap at 100
        }

        /**
         * Main function to start content gap analysis
         */
        async function startGapAnalysis() {
            // Save configuration
            const config = saveCurrentConfig();
            currentConfig = config;
            
            // Show loading state
            showLoadingState();
            
            try {
                // Generate topic combinations
                updateLoadingStatus('Generating content combinations...');
                const combinations = generateContentCombinations(config);
                
                updateLoadingStatus(`Analyzing ${combinations.length} content opportunities for gaps...`);
                
                // Analyze gaps in batches using Apps Script environment
                const batchSize = 10;
                const gaps = [];
                
                for (let i = 0; i < combinations.length; i += batchSize) {
                    const batch = combinations.slice(i, i + batchSize);
                    updateLoadingStatus(`Analyzing batch ${Math.floor(i/batchSize) + 1}/${Math.ceil(combinations.length/batchSize)}...`);
                    
                    // Process batch using Apps Script function
                    try {
                        const batchResults = await new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .processContentGapAnalysis(batch, config);
                        });
                        
                        // Collect gaps
                        if (batchResults && Array.isArray(batchResults)) {
                            batchResults.forEach(result => {
                                if (result && result.isGap) {
                                    gaps.push(result);
                                }
                            });
                        }
                    } catch (error) {
                        console.warn(`Batch ${Math.floor(i/batchSize) + 1} failed:`, error);
                        // Continue with other batches
                    }
                    
                    // Add delay to respect rate limits
                    if (i + batchSize < combinations.length) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                // Store results and display
                analysisResults = gaps;
                displayResults(gaps);
                
            } catch (error) {
                console.error('Content gap analysis failed:', error);
                hideLoadingState();
                showError(`Analysis failed: ${error.message}`);
            }
        }

        /**
         * Display gap analysis results
         */
        function displayResults(gaps) {
            hideLoadingState();
            
            // Show results section
            document.getElementById('results').classList.add('show');
            document.getElementById('filterSection').style.display = 'block';
            
            // Update statistics
            updateStats(gaps);
            
            // Populate category filter
            populateFilters(gaps);
            
            // Display gap cards
            renderGapCards(gaps);
        }

        /**
         * Update result statistics
         */
        function updateStats(gaps) {
            const stats = {
                total: gaps.length,
                high: gaps.filter(g => g.priority >= 80).length,
                avgOpportunity: gaps.length > 0 ? 
                    Math.round(gaps.reduce((sum, g) => sum + g.priority, 0) / gaps.length) : 0,
                categories: [...new Set(gaps.map(g => g.category))].length
            };
            
            document.getElementById('totalGaps').textContent = stats.total;
            document.getElementById('highPriorityGaps').textContent = stats.high;
            document.getElementById('avgOpportunity').textContent = stats.avgOpportunity;
            document.getElementById('totalCategories').textContent = stats.categories;
        }

        /**
         * Populate filter dropdowns
         */
        function populateFilters(gaps) {
            const categories = [...new Set(gaps.map(g => g.category))];
            const categoryFilter = document.getElementById('categoryFilter');
            
            // Clear existing options (except "All Categories")
            categoryFilter.innerHTML = '<option value="all">All Categories</option>';
            
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                categoryFilter.appendChild(option);
            });
        }

        /**
         * Render gap cards in the results grid
         */
        function renderGapCards(gaps) {
            const container = document.getElementById('gapResults');
            container.innerHTML = '';
            
            gaps.forEach(gap => {
                const card = createGapCard(gap);
                container.appendChild(card);
            });
        }

        /**
         * Create a gap card element
         */
        function createGapCard(gap) {
            const card = document.createElement('div');
            
            const priorityClass = getPriorityClass(gap.priority);
            card.className = `gap-card ${priorityClass}`;
            card.setAttribute('data-category', gap.category);
            card.setAttribute('data-content-type', gap.contentType);
            card.setAttribute('data-priority', getPriorityLevel(gap.priority));
            
            // Format GPT analysis for display
            const gptAnalysisHtml = gap.gptAnalysis ? 
                `<div class="gpt-analysis">
                    <h4>🎯 Content Strategy Analysis</h4>
                    <div class="analysis-content">${formatGptAnalysis(gap.gptAnalysis)}</div>
                    <button class="btn btn-sm btn-secondary toggle-analysis" onclick="toggleAnalysis(this)">Show Details</button>
                </div>` : '';
            
            card.innerHTML = `
                <div class="opportunity-score">${gap.priority}/100</div>
                <div class="gap-title">${gap.searchQuery}</div>
                <div class="gap-metadata">
                    <span class="metadata-tag ${getPriorityBadgeClass(gap.priority)}">
                        ${getPriorityLevel(gap.priority).toUpperCase()}
                    </span>
                    <span class="metadata-tag category-tag">
                        ${gap.category.replace(/_/g, ' ').toUpperCase()}
                    </span>
                    <span class="metadata-tag content-type">
                        ${gap.contentType.toUpperCase()}
                    </span>
                </div>
                <div class="gap-description">
                    ${gap.recommendation || 'Content opportunity identified - no existing coverage found.'}
                    ${gap.similarCount ? `<br><small>Found ${gap.similarCount} related articles with max ${gap.maxSimilarity}% similarity.</small>` : ''}
                </div>
                ${gptAnalysisHtml}
                <div class="gap-actions">
                    <button class="btn btn-primary btn-sm" onclick="addToContentCalendar('${gap.searchQuery}', '${gap.category}')">
                        📅 Add to Calendar
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="generateContentOutline('${gap.searchQuery}', '${gap.contentType}')">
                        📝 Generate Outline
                    </button>
                </div>
            `;
            
            return card;
        }

        /**
         * Format GPT analysis for HTML display
         */
        function formatGptAnalysis(analysis) {
            // Convert markdown-like formatting to HTML
            return analysis
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n- /g, '<br>• ')
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>');
        }

        /**
         * Toggle GPT analysis display
         */
        function toggleAnalysis(button) {
            const analysisContent = button.parentElement.querySelector('.analysis-content');
            const isHidden = analysisContent.style.display === 'none' || !analysisContent.style.display;
            
            if (isHidden) {
                analysisContent.style.display = 'block';
                button.textContent = 'Hide Details';
            } else {
                analysisContent.style.display = 'none';
                button.textContent = 'Show Details';
            }
        }

        /**
         * Get priority class for styling
         */
        function getPriorityClass(score) {
            if (score >= 80) return 'high-priority';
            if (score >= 60) return 'medium-priority';
            return 'low-priority';
        }

        /**
         * Get priority level text
         */
        function getPriorityLevel(score) {
            if (score >= 80) return 'high';
            if (score >= 60) return 'medium';
            return 'low';
        }

        /**
         * Get priority badge class
         */
        function getPriorityBadgeClass(score) {
            if (score >= 80) return 'priority-high';
            if (score >= 60) return 'priority-medium';
            return 'priority-low';
        }

        /**
         * Filter results based on selected criteria
         */
        function filterResults() {
            const priorityFilter = document.getElementById('priorityFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            const cards = document.querySelectorAll('.gap-card');
            
            cards.forEach(card => {
                let show = true;
                
                // Priority filter
                if (priorityFilter !== 'all' && card.getAttribute('data-priority') !== priorityFilter) {
                    show = false;
                }
                
                // Category filter
                if (categoryFilter !== 'all' && card.getAttribute('data-category') !== categoryFilter) {
                    show = false;
                }
                
                // Type filter
                if (typeFilter !== 'all' && card.getAttribute('data-content-type') !== typeFilter) {
                    show = false;
                }
                
                card.style.display = show ? 'block' : 'none';
            });
        }

        /**
         * Add content idea to calendar
         */
        function addToContentCalendar(query, category) {
            alert(`Added "${query}" (${category}) to content calendar!\n\n(This would integrate with your actual content management system)`);
        }

        /**
         * Generate content outline
         */
        function generateContentOutline(query, type) {
            alert(`Generating ${type} outline for "${query}"...\n\n(This would create a detailed content outline using AI)`);
        }

        /**
         * Load sample data for demonstration
         */
        function loadSampleData() {
            const sampleGaps = [
                {
                    topic: "WYSIWYG editor",
                    aspect: "performance optimization",
                    searchQuery: "WYSIWYG editor performance optimization",
                    category: "rich_text_editors",
                    contentType: "guide",
                    priority: 95,
                    isGap: true,
                    recommendation: "High-impact opportunity - create comprehensive performance guide"
                },
                {
                    topic: "file upload",
                    aspect: "security features", 
                    searchQuery: "file upload security features",
                    category: "file_management",
                    contentType: "guide",
                    priority: 88,
                    isGap: true,
                    recommendation: "Strong security focus - develop detailed security guide"
                },
                {
                    topic: "React integration",
                    aspect: "best practices",
                    searchQuery: "React integration best practices",
                    category: "web_development", 
                    contentType: "tutorial",
                    priority: 82,
                    isGap: true,
                    recommendation: "Good developer opportunity - create focused tutorial"
                },
                {
                    topic: "image processing",
                    aspect: "mobile optimization",
                    searchQuery: "image processing mobile optimization",
                    category: "file_management",
                    contentType: "guide",
                    priority: 78,
                    isGap: true,
                    recommendation: "Mobile focus - develop targeted optimization guide"
                },
                {
                    topic: "API integration",
                    aspect: "troubleshooting",
                    searchQuery: "API integration troubleshooting", 
                    category: "developer_tools",
                    contentType: "guide",
                    priority: 75,
                    isGap: true,
                    recommendation: "Developer support - create helpful troubleshooting guide"
                }
            ];
            
            analysisResults = sampleGaps;
            displayResults(sampleGaps);
        }

        /**
         * Export results to CSV
         */
        function exportResults() {
            if (!analysisResults.length) {
                alert('No results to export. Run an analysis first.');
                return;
            }
            
            const headers = ['Search Query', 'Category', 'Content Type', 'Priority Score', 'Recommendation'];
            const rows = analysisResults.map(gap => [
                gap.searchQuery,
                gap.category.replace(/_/g, ' '),
                gap.contentType,
                gap.priority,
                gap.recommendation || 'Content gap identified'
            ]);
            
            const csvContent = [headers, ...rows].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `content-gaps-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        /**
         * Show loading state
         */
        function showLoadingState() {
            document.getElementById('loading').classList.add('show');
            document.getElementById('results').classList.remove('show');
        }

        /**
         * Hide loading state
         */
        function hideLoadingState() {
            document.getElementById('loading').classList.remove('show');
        }

        /**
         * Update loading status text
         */
        function updateLoadingStatus(message) {
            document.getElementById('loadingStatus').textContent = message;
        }

        /**
         * Show error message
         */
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        /**
         * Hide error message
         */
        function hideError() {
            document.getElementById('error').classList.remove('show');
        }
    </script>
</body>
</html>