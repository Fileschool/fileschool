<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Top-Funnel Content Gap Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #EF4A25;
            --primary-light: #ff6b47;
            --primary-rgba: 239, 74, 37;
            --bg-gradient: linear-gradient(135deg, #ffdbcc 0%, #ffe4dc 100%);
            --header-gradient: linear-gradient(135deg, #EF4A25 0%, #ff6b47 100%);
            --button-gradient: linear-gradient(135deg, #EF4A25 0%, #ff6b47 100%);
            --keyword-gradient: linear-gradient(135deg, #EF4A25 0%, #ff6b47 100%);
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --shadow-hover: 0 20px 40px rgba(0,0,0,0.15);
            --secondary-color: #6c757d;
            --secondary-rgba: 108, 117, 125;
            --accent-color: #FF6B35;
            --accent-light: #FF8A65;
        }
        
        .froala-theme {
            --primary-color: #0098F7;
            --primary-light: #33aaff;
            --primary-rgba: 0, 152, 247;
            --bg-gradient: linear-gradient(135deg, #cce7ff 0%, #e6f3ff 100%);
            --header-gradient: linear-gradient(135deg, #0098F7 0%, #33aaff 100%);
            --button-gradient: linear-gradient(135deg, #0098F7 0%, #33aaff 100%);
            --keyword-gradient: linear-gradient(135deg, #0098F7 0%, #33aaff 100%);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            transition: background 0.3s ease;
        }
        
        .container {
            width: 100%;
            max-width: none;
            margin: 0;
            background: white;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
        }
        
        .header {
            background: var(--header-gradient);
            color: white;
            padding: 30px 40px;
            text-align: center;
            transition: background 0.3s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 0;
            width: 100%;
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 0;
            min-height: calc(100vh - 120px);
            position: relative;
            overflow: hidden;
        }
        
        .config-section {
            position: sticky;
            top: 0;
            height: calc(100vh - 120px);
            background: white;
            backdrop-filter: none;
            border-radius: 0;
            padding: 40px 30px;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            border: none;
            border-right: 1px solid #e1e8ed;
            overflow-y: auto;
            grid-column: 1;
            z-index: 10;
        }
        
        .results-section {
            overflow-y: auto;
            height: calc(100vh - 120px);
            padding: 40px;
            background: #f8f9fa;
            grid-column: 2;
        }
        
        .results-section::-webkit-scrollbar {
            width: 8px;
        }
        
        .results-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .results-section::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }
        
        .results-section::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-rgba), 0.2);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-direction: column;
        }
        
        .btn {
            padding: 15px 30px;
            border: 2px solid transparent;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: var(--button-gradient);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 4px 15px rgba(var(--primary-rgba), 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(var(--primary-rgba), 0.5);
            border-color: var(--primary-light);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 8px rgba(var(--primary-rgba), 0.2);
        }
        
        .btn-secondary {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            border-color: #5a6268;
            transform: translateY(-2px);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: var(--primary-color);
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            display: none;
            animation: slideIn 0.5s ease-out;
        }
        
        .results.show {
            display: block;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--primary-color);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            display: block;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #6c757d;
            font-weight: 600;
        }
        
        .gap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .gap-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .gap-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .gap-card.high-priority {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
        }
        
        .gap-card.medium-priority {
            border-left-color: var(--accent-color);
            background: linear-gradient(135deg, #fff8f5 0%, #ffffff 100%);
        }
        
        .gap-card.low-priority {
            border-left-color: var(--primary-color);
            background: linear-gradient(135deg, #f8fff9 0%, #ffffff 100%);
        }
        
        .gap-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            line-height: 1.3;
        }
        
        .gap-metadata {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .metadata-tag {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .priority-high {
            background: #dc3545;
            color: white;
        }
        
        .priority-medium {
            background: var(--accent-color);
            color: white;
        }
        
        .priority-low {
            background: var(--primary-color);
            color: white;
        }
        
        .funnel-stage {
            background: var(--primary-color);
            color: white;
        }
        
        .content-type {
            background: #6c757d;
            color: white;
        }
        
        .gap-description {
            color: #6c757d;
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }
        
        .gap-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
            border-radius: 8px;
        }
        
        .filter-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .opportunity-score {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .error {
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            color: #c62828;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid #ffcdd2;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .config-section {
                position: static;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #e1e8ed;
                grid-column: 1;
            }
            
            .results-section {
                height: auto;
                overflow-y: visible;
                padding: 20px;
                grid-column: 1;
            }
            
            .gap-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
        
        /* Source Selection Styles */
        .source-selection {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 10px;
        }
        
        .radio-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 24px;
            border: 3px solid #e1e8ed;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            position: relative;
            overflow: hidden;
            flex: 1;
        }
        
        .radio-group::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(var(--primary-rgba), 0.05), transparent);
            transition: left 0.5s ease;
        }
        
        .radio-group:hover::before {
            left: 100%;
        }
        
        .radio-group:hover {
            border-color: var(--primary-color);
            background: rgba(var(--primary-rgba), 0.08);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--primary-rgba), 0.15);
        }
        
        .radio-group input[type="radio"] {
            margin: 0;
            transform: scale(1.2);
            accent-color: var(--primary-color);
        }
        
        .radio-group.selected {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, rgba(var(--primary-rgba), 0.15) 0%, rgba(var(--primary-rgba), 0.08) 100%);
            box-shadow: 0 4px 15px rgba(var(--primary-rgba), 0.2);
            transform: translateY(-1px);
        }
        
        .radio-group label {
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
            user-select: none;
        }
        
        /* GPT Analysis Styles */
        .gpt-analysis {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(var(--primary-rgba), 0.05) 0%, rgba(var(--primary-rgba), 0.02) 100%);
            border: 1px solid rgba(var(--primary-rgba), 0.1);
            border-radius: 12px;
        }
        
        .gpt-analysis h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .analysis-content {
            display: none;
            color: #555;
            line-height: 1.6;
            font-size: 0.95rem;
        }
        
        .analysis-content strong {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .toggle-analysis {
            margin-top: 15px;
            background: var(--primary-color) !important;
            color: white !important;
            border: none !important;
        }
        
        .toggle-analysis:hover {
            background: var(--primary-light) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Top-Funnel Content Gap Analyzer</h1>
            <p>Discover awareness-stage content opportunities using AI-powered topic analysis</p>
        </div>
        
        <div class="main-content">
            <div class="config-section">
                <div class="form-group">
                    <label>‚öôÔ∏è Analysis Configuration</label>
                </div>
                
                <div class="form-group">
                    <label>üéØ Check against which blog source:</label>
                    <div class="source-selection">
                        <div class="radio-group selected" onclick="selectSource('filestack')">
                            <input type="radio" id="filestack" name="source" value="filestack" checked>
                            <label for="filestack">üìö Filestack Blogs</label>
                        </div>
                        <div class="radio-group" onclick="selectSource('froala')">
                            <input type="radio" id="froala" name="source" value="froala">
                            <label for="froala">‚ú® Froala Blogs</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-grid">
                    
                    <div class="form-group">
                        <label for="analysisDepth">üìä Analysis Depth</label>
                        <select id="analysisDepth">
                            <option value="quick">Quick Scan (Top 25 opportunities)</option>
                            <option value="standard" selected>Standard (Top 100 opportunities)</option>
                            <option value="comprehensive">Comprehensive (Top 500 opportunities)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="funnelFocus">üé™ Funnel Stage Focus</label>
                        <select id="funnelFocus">
                            <option value="awareness" selected>Awareness Stage</option>
                            <option value="problem_recognition">Problem Recognition</option>
                            <option value="solution_exploration">Solution Exploration</option>
                            <option value="mixed">Mixed Top-Funnel</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="industryFocus">üè¢ Industry Focus</label>
                        <select id="industryFocus">
                            <option value="all" selected>All Industries</option>
                            <option value="saas">SaaS & Software</option>
                            <option value="ecommerce">E-commerce</option>
                            <option value="fintech">FinTech</option>
                            <option value="healthcare">Healthcare Tech</option>
                            <option value="education">EdTech</option>
                            <option value="marketing">Marketing & Advertising</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="minSimilarity">üìè Gap Threshold</label>
                        <select id="minSimilarity">
                            <option value="0.2">20% (Very sensitive - find micro-gaps)</option>
                            <option value="0.3" selected>30% (Balanced gap detection)</option>
                            <option value="0.4">40% (Only significant gaps)</option>
                        </select>
                    </div>
                </div>

                <div class="button-group">
                    <button id="startAnalysis" class="btn btn-primary" onclick="startTopFunnelAnalysis()">
                        üöÄ Find Content Gaps
                    </button>
                    <button class="btn btn-secondary" onclick="loadSampleData()">
                        üìä Load Sample Data
                    </button>
                    <button class="btn btn-secondary" onclick="exportResults()">
                        üì§ Export Opportunities
                    </button>
                </div>
                
                <!-- Tool Navigation -->
                <div class="form-group" style="margin-top: 30px; border-top: 2px solid #e1e8ed; padding-top: 20px;">
                    <label>üß∞ Content Analysis Tools</label>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 15px;">
                        <button class="btn btn-secondary btn-sm" onclick="loadSimilarityChecker()" style="font-size: 14px;">
                            üîç Back to Similarity Checker
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="loadContentGapAnalyzer()" style="font-size: 14px;">
                            üìä Content Gap Analyzer
                        </button>
                    </div>
                </div>
                
                <div id="error" class="error"></div>
                
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <h3>Analyzing Top-Funnel Gaps...</h3>
                    <p id="loadingStatus">Initializing analysis...</p>
                </div>
            </div>
            
            <div class="results-section">
                <div id="results" class="results">
                    <!-- Stats Overview -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <span class="stat-number" id="totalGaps">0</span>
                            <span class="stat-label">Content Gaps Found</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="highPriorityGaps">0</span>
                            <span class="stat-label">High Priority</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="awarenessGaps">0</span>
                            <span class="stat-label">Awareness Stage</span>
                        </div>
                        <div class="stat-card">
                            <span class="stat-number" id="avgOpportunity">0</span>
                            <span class="stat-label">Avg Opportunity Score</span>
                        </div>
                    </div>

                    <!-- Filter Section -->
                    <div class="filter-section" id="filterSection" style="display: none;">
                        <h4>üîç Filter Opportunities</h4>
                        <div class="filter-grid">
                            <div class="form-group">
                                <label for="priorityFilter">Priority Level</label>
                                <select id="priorityFilter" onchange="filterResults()">
                                    <option value="all">All Priorities</option>
                                    <option value="high">High Priority Only</option>
                                    <option value="medium">Medium Priority Only</option>
                                    <option value="low">Low Priority Only</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="stageFilter">Funnel Stage</label>
                                <select id="stageFilter" onchange="filterResults()">
                                    <option value="all">All Stages</option>
                                    <option value="awareness">Awareness</option>
                                    <option value="problem_recognition">Problem Recognition</option>
                                    <option value="solution_exploration">Solution Exploration</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="typeFilter">Content Type</label>
                                <select id="typeFilter" onchange="filterResults()">
                                    <option value="all">All Types</option>
                                    <option value="guide">Guides</option>
                                    <option value="comparison">Comparisons</option>
                                    <option value="explanation">Explanations</option>
                                    <option value="list">Lists</option>
                                    <option value="trend">Trends</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Gap Results -->
                    <div class="gap-grid" id="gapResults">
                        <!-- Gap cards will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * Top-Funnel Content Gap Analyzer
         * Finds awareness-stage content opportunities using AI-powered topic analysis
         * Integrates with existing Apps Script environment variables
         */

        // Top-Funnel Topic Taxonomy - Froala & Filestack Focus
        const TOP_FUNNEL_TAXONOMY = {
            // Awareness Stage Topics - "What is" content
            awareness: {
                // Editor & Content Creation Definitions
                editor_definitions: [
                    "what is WYSIWYG editor", "what is rich text editor", "what is HTML editor",
                    "what is visual editor", "what is content editor", "what is text editor",
                    "what is inline editing", "what is markdown editor", "what is code editor",
                    "what is syntax highlighting", "what is collaborative editing", "what is real-time editing",
                    "what is content management", "what is document editing", "what is text formatting",
                    "what is editor customization", "what is editor plugin", "what is editor theme"
                ],
                
                // File Management Definitions
                file_definitions: [
                    "what is file upload", "what is file picker", "what is file transformation",
                    "what is image processing", "what is file conversion", "what is CDN",
                    "what is cloud storage", "what is file optimization", "what is image optimization",
                    "what is file compression", "what is thumbnail generation", "what is asset management",
                    "what is digital asset management", "what is file delivery", "what is upload widget",
                    "what is drag and drop upload", "what is bulk upload", "what is file security"
                ],
                
                // Web Development Fundamentals
                web_fundamentals: [
                    "JavaScript basics", "HTML fundamentals", "CSS introduction",
                    "React overview", "Vue.js basics", "Angular introduction",
                    "API basics", "SDK explained", "plugin development overview",
                    "responsive design basics", "mobile optimization introduction",
                    "web components explained", "progressive web apps overview"
                ],

                // Business & Industry Concepts
                business_concepts: [
                    "content management explained", "digital asset management overview",
                    "SaaS business model", "API economy basics", "developer tools market",
                    "content marketing fundamentals", "user experience basics",
                    "web development workflow", "content creation process",
                    "editorial workflow explained", "publishing platform basics"
                ],

                // Technology Trends  
                tech_trends: [
                    "future of content editing", "collaborative editing trends",
                    "headless CMS movement", "API-first development", "jamstack architecture",
                    "no-code content tools", "visual editing evolution", "real-time collaboration",
                    "cloud-based editing", "mobile content creation", "AI-powered editing"
                ]
            },

            // Problem Recognition Stage - "Why does this matter" content
            problem_recognition: {
                // Pain Points & Challenges
                pain_points: [
                    "content editing challenges", "file upload problems", "editor performance issues",
                    "integration difficulties", "user experience problems", "security concerns",
                    "scalability limitations", "customization barriers", "collaboration problems",
                    "mobile editing issues", "cross-browser compatibility", "plugin conflicts"
                ],

                // Warning Signs & Symptoms
                warning_signs: [
                    "signs you need better editor", "when to upgrade file upload",
                    "symptoms of poor editing UX", "indicators of slow uploads",
                    "signs of security vulnerabilities", "warning signs of integration issues",
                    "symptoms of poor performance", "indicators of user frustration"
                ],

                // Impact & Consequences
                consequences: [
                    "cost of poor editing experience", "impact of slow file uploads",
                    "consequences of security breaches", "price of poor integration",
                    "cost of user abandonment", "impact of mobile issues",
                    "consequences of outdated editors", "price of poor performance"
                ]
            },

            // Solution Exploration Stage - "How to approach this" content
            solution_exploration: {
                // Approaches & Methodologies
                approaches: [
                    "WYSIWYG vs markdown", "cloud vs local storage",
                    "custom vs third-party editor", "hosted vs self-hosted",
                    "real-time vs batch processing", "client-side vs server-side"
                ],

                // Framework Comparisons
                comparisons: [
                    "Froala vs TinyMCE", "Filestack vs Cloudinary",
                    "React editors comparison", "Vue editor options",
                    "Angular rich text solutions", "WordPress editor plugins"
                ],

                // Decision Frameworks
                decisions: [
                    "how to choose rich text editor", "selecting file upload solution",
                    "picking editor framework", "choosing upload strategy",
                    "evaluating editor features", "comparing upload services"
                ]
            },

            // Content Types for Top-Funnel
            content_types: {
                // Educational Content
                guides: [
                    "complete guide to", "ultimate guide to", "beginner's guide to",
                    "step-by-step guide", "comprehensive overview", "introduction to",
                    "getting started with", "basics of", "fundamentals of",
                    "crash course in", "primer on", "overview of"
                ],

                // Comparative Content
                comparisons: [
                    "vs", "compared", "comparison", "alternatives to",
                    "competitors", "similar to", "better than", "versus",
                    "pros and cons", "advantages and disadvantages",
                    "strengths and weaknesses", "side by side comparison"
                ],

                // Explanatory Content
                explanations: [
                    "how does", "why is", "what are the benefits",
                    "what are the advantages", "what makes", "how to understand",
                    "explaining", "demystifying", "breaking down",
                    "simplifying", "understanding", "decoded"
                ],

                // List Content
                lists: [
                    "best", "top", "essential", "must-have", "important",
                    "popular", "trending", "recommended", "useful",
                    "powerful", "effective", "proven", "leading",
                    "game-changing", "innovative", "cutting-edge"
                ],

                // Trend Content
                trends: [
                    "trends in", "future of", "evolution of", "next generation",
                    "emerging", "upcoming", "latest in", "innovations in",
                    "developments in", "advances in", "breakthroughs in",
                    "state of", "outlook for", "predictions for"
                ]
            }
        };

        // Content Intent Patterns for Top-Funnel
        const TOP_FUNNEL_PATTERNS = {
            awareness: [
                "what is {topic}",
                "introduction to {topic}",
                "{topic} explained",
                "{topic} overview",
                "{topic} basics",
                "{topic} fundamentals",
                "understanding {topic}",
                "{topic} for beginners",
                "{topic} definition",
                "guide to {topic}"
            ],
            
            problem_recognition: [
                "why {topic} matters",
                "{topic} challenges",
                "{topic} problems",
                "issues with {topic}",
                "{topic} pain points",
                "common {topic} mistakes",
                "{topic} warning signs",
                "when to use {topic}",
                "do you need {topic}",
                "{topic} red flags"
            ],
            
            solution_exploration: [
                "how to choose {topic}",
                "{topic} alternatives",
                "{topic} vs {alternative}",
                "best {topic} for",
                "{topic} comparison",
                "types of {topic}",
                "{topic} approaches",
                "{topic} strategies",
                "{topic} methods",
                "selecting {topic}"
            ]
        };

        // Global variables
        let analysisResults = [];
        let currentConfig = {};

        /**
         * Initialize the application
         */
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved configuration
            loadSavedConfig();
        });

        /**
         * Load saved configuration from localStorage
         */
        function loadSavedConfig() {
            const saved = localStorage.getItem('topFunnelConfig');
            if (saved) {
                const config = JSON.parse(saved);
                const source = config.source || 'filestack';
                
                // Set radio button selection
                document.getElementById('filestack').checked = (source === 'filestack');
                document.getElementById('froala').checked = (source === 'froala');
                
                // Update visual selection
                document.querySelectorAll('.radio-group').forEach(group => {
                    group.classList.remove('selected');
                });
                
                if (source === 'froala') {
                    document.querySelector('.radio-group:nth-child(2)').classList.add('selected');
                } else {
                    document.querySelector('.radio-group:nth-child(1)').classList.add('selected');
                }
                
                document.getElementById('analysisDepth').value = config.analysisDepth || 'standard';
                document.getElementById('funnelFocus').value = config.funnelFocus || 'awareness';
                document.getElementById('industryFocus').value = config.industryFocus || 'all';
                document.getElementById('minSimilarity').value = config.minSimilarity || '0.3';
                
                // Update theme
                updateTheme(source);
            }
        }

        /**
         * Save current configuration to localStorage
         */
        function saveCurrentConfig() {
            const source = document.querySelector('input[name="source"]:checked')?.value || 'filestack';
            const config = {
                source: source,
                collection: source === 'froala' ? 'froala_blogs' : 'filestack_blogs',
                analysisDepth: document.getElementById('analysisDepth').value,
                funnelFocus: document.getElementById('funnelFocus').value,
                industryFocus: document.getElementById('industryFocus').value,
                minSimilarity: document.getElementById('minSimilarity').value
            };
            localStorage.setItem('topFunnelConfig', JSON.stringify(config));
            return config;
        }

        /**
         * Handle source selection
         */
        function selectSource(source) {
            // Update radio buttons
            document.getElementById('filestack').checked = (source === 'filestack');
            document.getElementById('froala').checked = (source === 'froala');
            
            // Update visual selection
            document.querySelectorAll('.radio-group').forEach(group => {
                group.classList.remove('selected');
            });
            event.target.closest('.radio-group').classList.add('selected');
            
            // Update theme based on source
            updateTheme(source);
        }

        /**
         * Update theme colors based on selected source
         */
        function updateTheme(source) {
            const body = document.body;
            if (source === 'froala') {
                body.classList.add('froala-theme');
            } else {
                body.classList.remove('froala-theme');
            }
        }

        /**
         * Generate top-funnel content combinations
         */
        function generateTopFunnelCombinations(config) {
            const combinations = [];
            const limits = {
                quick: 25,
                standard: 100,
                comprehensive: 500
            };
            
            const limit = limits[config.analysisDepth] || 100;
            let count = 0;

            // Get relevant stages based on funnel focus
            const stageData = config.funnelFocus === 'mixed' ? 
                TOP_FUNNEL_TAXONOMY : 
                { [config.funnelFocus]: TOP_FUNNEL_TAXONOMY[config.funnelFocus] };

            // Generate combinations for each stage
            for (const [stageName, stageContent] of Object.entries(stageData)) {
                if (!TOP_FUNNEL_TAXONOMY[stageName]) continue;

                for (const [categoryName, topics] of Object.entries(stageContent)) {
                    if (!Array.isArray(topics)) continue;

                    for (const topic of topics.slice(0, 50)) { // Limit topics per category
                        if (count >= limit) break;

                        // Generate different content patterns
                        const patterns = TOP_FUNNEL_PATTERNS[stageName] || TOP_FUNNEL_PATTERNS.awareness;
                        
                        for (const pattern of patterns.slice(0, 3)) { // Top 3 patterns per topic
                            if (count >= limit) break;

                            const searchQuery = pattern.replace('{topic}', topic);
                            const contentType = determineContentType(pattern);
                            
                            combinations.push({
                                topic,
                                pattern,
                                searchQuery,
                                funnelStage: stageName,
                                category: categoryName,
                                contentType,
                                priority: calculateTopFunnelPriority(topic, stageName, contentType, config)
                            });
                            count++;
                        }
                    }
                }
            }

            // Sort by priority (high to low)
            return combinations.sort((a, b) => b.priority - a.priority);
        }

        /**
         * Determine content type from pattern
         */
        function determineContentType(pattern) {
            if (pattern.includes('vs') || pattern.includes('comparison')) return 'comparison';
            if (pattern.includes('guide') || pattern.includes('how to')) return 'guide';
            if (pattern.includes('what is') || pattern.includes('explained')) return 'explanation';
            if (pattern.includes('best') || pattern.includes('top')) return 'list';
            if (pattern.includes('trends') || pattern.includes('future')) return 'trend';
            return 'guide';
        }

        /**
         * Calculate priority score for top-funnel combinations
         */
        function calculateTopFunnelPriority(topic, stage, contentType, config) {
            let priority = 50; // Base priority

            // High-value awareness topics
            const highValueTopics = [
                'rich text editor', 'WYSIWYG editor', 'file upload', 'image processing',
                'content management', 'digital asset management', 'API', 'SDK'
            ];
            
            if (highValueTopics.some(hvt => topic.toLowerCase().includes(hvt.toLowerCase()))) {
                priority += 25;
            }

            // Stage-based scoring
            const stageScores = {
                awareness: 20,        // Highest - top funnel focus
                problem_recognition: 15,
                solution_exploration: 10
            };
            priority += stageScores[stage] || 0;

            // Content type scoring
            const typeScores = {
                guide: 15,      // Educational content scores high
                explanation: 15,
                comparison: 12,
                list: 10,
                trend: 8
            };
            priority += typeScores[contentType] || 0;

            // Search volume indicators (topics with high search potential)
            const highSearchTopics = [
                'what is', 'how to', 'best', 'vs', 'guide', 'tutorial', 
                'explained', 'overview', 'introduction'
            ];
            
            if (highSearchTopics.some(hst => topic.includes(hst))) {
                priority += 15;
            }

            return Math.min(priority, 100); // Cap at 100
        }

        /**
         * Main function to start top-funnel analysis
         */
        async function startTopFunnelAnalysis() {
            // Save configuration
            const config = saveCurrentConfig();
            currentConfig = config;
            
            // Show loading state
            showLoadingState();
            
            try {
                // Generate topic combinations
                updateLoadingStatus('Generating top-funnel topic combinations...');
                const combinations = generateTopFunnelCombinations(config);
                
                updateLoadingStatus(`Analyzing ${combinations.length} opportunities for content gaps...`);
                
                // Analyze gaps in batches using Apps Script environment
                const batchSize = 10;
                const gaps = [];
                
                for (let i = 0; i < combinations.length; i += batchSize) {
                    const batch = combinations.slice(i, i + batchSize);
                    updateLoadingStatus(`Analyzing batch ${Math.floor(i/batchSize) + 1}/${Math.ceil(combinations.length/batchSize)}...`);
                    
                    // Process batch using Apps Script function
                    try {
                        const batchResults = await new Promise((resolve, reject) => {
                            google.script.run
                                .withSuccessHandler(resolve)
                                .withFailureHandler(reject)
                                .processTopFunnelAnalysis(batch, config);
                        });
                        
                        // Collect gaps
                        if (batchResults && Array.isArray(batchResults)) {
                            batchResults.forEach(result => {
                                if (result && result.isGap) {
                                    gaps.push(result);
                                }
                            });
                        }
                    } catch (error) {
                        console.warn(`Batch ${Math.floor(i/batchSize) + 1} failed:`, error);
                        // Continue with other batches
                    }
                    
                    // Add delay to respect rate limits
                    if (i + batchSize < combinations.length) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                // Store results and display
                analysisResults = gaps;
                displayTopFunnelResults(gaps);
                
            } catch (error) {
                console.error('Top-funnel analysis failed:', error);
                hideLoadingState();
                showError(`Analysis failed: ${error.message}`);
            }
        }

        /**
         * Display top-funnel gap results
         */
        function displayTopFunnelResults(gaps) {
            hideLoadingState();
            
            // Show results section
            document.getElementById('results').classList.add('show');
            document.getElementById('filterSection').style.display = 'block';
            
            // Update statistics
            updateTopFunnelStats(gaps);
            
            // Display gap cards
            renderTopFunnelGapCards(gaps);
        }

        /**
         * Update result statistics
         */
        function updateTopFunnelStats(gaps) {
            const stats = {
                total: gaps.length,
                high: gaps.filter(g => g.priority >= 80).length,
                awareness: gaps.filter(g => g.funnelStage === 'awareness').length,
                avgOpportunity: gaps.length > 0 ? 
                    Math.round(gaps.reduce((sum, g) => sum + g.priority, 0) / gaps.length) : 0
            };
            
            document.getElementById('totalGaps').textContent = stats.total;
            document.getElementById('highPriorityGaps').textContent = stats.high;
            document.getElementById('awarenessGaps').textContent = stats.awareness;
            document.getElementById('avgOpportunity').textContent = stats.avgOpportunity;
        }

        /**
         * Render gap cards in the results grid
         */
        function renderTopFunnelGapCards(gaps) {
            const container = document.getElementById('gapResults');
            container.innerHTML = '';
            
            gaps.forEach(gap => {
                const card = createTopFunnelGapCard(gap);
                container.appendChild(card);
            });
        }

        /**
         * Create a top-funnel gap card element
         */
        function createTopFunnelGapCard(gap) {
            const card = document.createElement('div');
            
            const priorityClass = getPriorityClass(gap.priority);
            card.className = `gap-card ${priorityClass}`;
            card.setAttribute('data-funnel-stage', gap.funnelStage);
            card.setAttribute('data-content-type', gap.contentType);
            card.setAttribute('data-priority', getPriorityLevel(gap.priority));
            
            // Create content description
            const contentDescription = generateContentDescription(gap);
            
            // Format GPT analysis for display
            const gptAnalysisHtml = gap.gptAnalysis ? 
                `<div class="gpt-analysis">
                    <h4>üéØ Top-Funnel Strategy Analysis</h4>
                    <div class="analysis-content">${formatGptAnalysis(gap.gptAnalysis)}</div>
                    <button class="btn btn-sm btn-secondary toggle-analysis" onclick="toggleAnalysis(this)">Show Details</button>
                </div>` : '';
            
            card.innerHTML = `
                <div class="opportunity-score">${gap.priority}/100</div>
                <div class="gap-title">${gap.searchQuery}</div>
                <div class="gap-metadata">
                    <span class="metadata-tag ${getPriorityBadgeClass(gap.priority)}">
                        ${getPriorityLevel(gap.priority).toUpperCase()}
                    </span>
                    <span class="metadata-tag funnel-stage">
                        ${gap.funnelStage.replace('_', ' ').toUpperCase()}
                    </span>
                    <span class="metadata-tag content-type">
                        ${gap.contentType.toUpperCase()}
                    </span>
                </div>
                <div class="gap-description">
                    ${contentDescription}
                    <br><br>
                    <strong>Target Audience:</strong> ${getTargetAudience(gap.funnelStage)}<br>
                    <strong>Content Goal:</strong> ${getContentGoal(gap.funnelStage)}
                </div>
                ${gptAnalysisHtml}
                <div class="gap-actions">
                    <button class="btn btn-primary btn-sm" onclick="addToContentCalendar('${gap.searchQuery}', '${gap.funnelStage}')">
                        üìÖ Add to Calendar
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="generateContentOutline('${gap.searchQuery}', '${gap.contentType}')">
                        üìù Generate Outline
                    </button>
                </div>
            `;
            
            return card;
        }

        /**
         * Format GPT analysis for HTML display
         */
        function formatGptAnalysis(analysis) {
            // Convert markdown-like formatting to HTML
            return analysis
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n- /g, '<br>‚Ä¢ ')
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>');
        }

        /**
         * Toggle GPT analysis display
         */
        function toggleAnalysis(button) {
            const analysisContent = button.parentElement.querySelector('.analysis-content');
            const isHidden = analysisContent.style.display === 'none' || !analysisContent.style.display;
            
            if (isHidden) {
                analysisContent.style.display = 'block';
                button.textContent = 'Hide Details';
            } else {
                analysisContent.style.display = 'none';
                button.textContent = 'Show Details';
            }
        }

        /**
         * Generate content description for gap
         */
        function generateContentDescription(gap) {
            const descriptions = {
                awareness: `Create educational content that introduces "${gap.topic}" to newcomers. This content should focus on explaining basic concepts, providing clear definitions, and helping readers understand the fundamentals without assuming prior knowledge.`,
                problem_recognition: `Develop content that helps readers recognize when they need to consider "${gap.topic}". Focus on pain points, warning signs, and scenarios where this topic becomes relevant to their business or workflow.`,
                solution_exploration: `Produce content that guides readers through different approaches to "${gap.topic}". Compare options, methodologies, and help them understand how to evaluate different solutions.`
            };
            
            return descriptions[gap.funnelStage] || descriptions.awareness;
        }

        /**
         * Get target audience for funnel stage
         */
        function getTargetAudience(stage) {
            const audiences = {
                awareness: 'Complete beginners, newcomers to the space',
                problem_recognition: 'People experiencing related challenges',
                solution_exploration: 'Actively evaluating options and approaches'
            };
            
            return audiences[stage] || audiences.awareness;
        }

        /**
         * Get content goal for funnel stage  
         */
        function getContentGoal(stage) {
            const goals = {
                awareness: 'Educate and build brand awareness',
                problem_recognition: 'Help identify problems and create urgency',
                solution_exploration: 'Guide evaluation and build consideration'
            };
            
            return goals[stage] || goals.awareness;
        }

        /**
         * Get priority class for styling
         */
        function getPriorityClass(score) {
            if (score >= 80) return 'high-priority';
            if (score >= 60) return 'medium-priority';
            return 'low-priority';
        }

        /**
         * Get priority level text
         */
        function getPriorityLevel(score) {
            if (score >= 80) return 'high';
            if (score >= 60) return 'medium';
            return 'low';
        }

        /**
         * Get priority badge class
         */
        function getPriorityBadgeClass(score) {
            if (score >= 80) return 'priority-high';
            if (score >= 60) return 'priority-medium';
            return 'priority-low';
        }

        /**
         * Filter results based on selected criteria
         */
        function filterResults() {
            const priorityFilter = document.getElementById('priorityFilter').value;
            const stageFilter = document.getElementById('stageFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            const cards = document.querySelectorAll('.gap-card');
            
            cards.forEach(card => {
                let show = true;
                
                // Priority filter
                if (priorityFilter !== 'all' && card.getAttribute('data-priority') !== priorityFilter) {
                    show = false;
                }
                
                // Stage filter
                if (stageFilter !== 'all' && card.getAttribute('data-funnel-stage') !== stageFilter) {
                    show = false;
                }
                
                // Type filter
                if (typeFilter !== 'all' && card.getAttribute('data-content-type') !== typeFilter) {
                    show = false;
                }
                
                card.style.display = show ? 'block' : 'none';
            });
        }

        /**
         * Add content idea to calendar
         */
        function addToContentCalendar(query, stage) {
            alert(`Added "${query}" (${stage} stage) to content calendar!\n\n(This would integrate with your actual content management system)`);
        }

        /**
         * Generate content outline
         */
        function generateContentOutline(query, type) {
            alert(`Generating ${type} outline for "${query}"...\n\n(This would create a detailed content outline using AI)`);
        }

        /**
         * Load sample data for demonstration
         */
        function loadSampleData() {
            const sampleGaps = [
                {
                    topic: "WYSIWYG editor",
                    searchQuery: "what is WYSIWYG editor",
                    funnelStage: "awareness",
                    contentType: "explanation",
                    priority: 95,
                    category: "editor_definitions",
                    isGap: true
                },
                {
                    topic: "file upload",
                    searchQuery: "file upload vs cloud storage",
                    funnelStage: "solution_exploration", 
                    contentType: "comparison",
                    priority: 88,
                    category: "approaches",
                    isGap: true
                },
                {
                    topic: "rich text editor",
                    searchQuery: "signs you need rich text editor",
                    funnelStage: "problem_recognition",
                    contentType: "guide",
                    priority: 82,
                    category: "warning_signs",
                    isGap: true
                },
                {
                    topic: "content management",
                    searchQuery: "content management for beginners",
                    funnelStage: "awareness",
                    contentType: "guide", 
                    priority: 78,
                    category: "business_concepts",
                    isGap: true
                },
                {
                    topic: "image processing",
                    searchQuery: "best image processing practices",
                    funnelStage: "solution_exploration",
                    contentType: "list",
                    priority: 75,
                    category: "approaches",
                    isGap: true
                }
            ];
            
            analysisResults = sampleGaps;
            displayTopFunnelResults(sampleGaps);
        }

        /**
         * Export results to CSV
         */
        function exportResults() {
            if (!analysisResults.length) {
                alert('No results to export. Run an analysis first.');
                return;
            }
            
            const headers = ['Search Query', 'Funnel Stage', 'Content Type', 'Priority Score', 'Target Audience', 'Content Goal'];
            const rows = analysisResults.map(gap => [
                gap.searchQuery,
                gap.funnelStage.replace('_', ' '),
                gap.contentType,
                gap.priority,
                getTargetAudience(gap.funnelStage),
                getContentGoal(gap.funnelStage)
            ]);
            
            const csvContent = [headers, ...rows].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `top-funnel-opportunities-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        /**
         * Show loading state
         */
        function showLoadingState() {
            document.getElementById('loading').classList.add('show');
            document.getElementById('startAnalysis').disabled = true;
            document.getElementById('results').classList.remove('show');
        }

        /**
         * Hide loading state
         */
        function hideLoadingState() {
            document.getElementById('loading').classList.remove('show');
            document.getElementById('startAnalysis').disabled = false;
        }

        /**
         * Update loading status text
         */
        function updateLoadingStatus(message) {
            document.getElementById('loadingStatus').textContent = message;
        }

        /**
         * Show error message
         */
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }

        /**
         * Hide error message
         */
        function hideError() {
            document.getElementById('error').classList.remove('show');
        }
        
        /**
         * Navigation functions for content analysis tools
         */
        function loadSimilarityChecker() {
            if (typeof google !== 'undefined' && google.script) {
                // Use Apps Script HTML service to load the main tool
                google.script.run
                    .withSuccessHandler((html) => {
                        document.open();
                        document.write(html);
                        document.close();
                    })
                    .withFailureHandler((error) => {
                        console.error('Failed to load Similarity Checker:', error);
                    })
                    .getSimilarityCheckerHtml();
            } else {
                // For local testing/development
                window.location.href = 'index.html';
            }
        }
        
        function loadContentGapAnalyzer() {
            if (typeof google !== 'undefined' && google.script) {
                google.script.run
                    .withSuccessHandler((html) => {
                        document.open();
                        document.write(html);
                        document.close();
                    })
                    .withFailureHandler((error) => {
                        console.error('Failed to load Content Gap Analyzer:', error);
                    })
                    .getContentGapAnalyzerHtml();
            } else {
                window.location.href = 'content-gap-analyzer.html';
            }
        }
    </script>
</body>
</html>