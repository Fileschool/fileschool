<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blog Similarity Checker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #EF4A25;
            --primary-light: #ff6b47;
            --primary-rgba: 239, 74, 37;
            --bg-gradient: linear-gradient(135deg, #ffdbcc 0%, #ffe4dc 100%);
            --header-gradient: linear-gradient(135deg, #EF4A25 0%, #ff6b47 100%);
            --button-gradient: linear-gradient(135deg, #EF4A25 0%, #ff6b47 100%);
            --keyword-gradient: linear-gradient(135deg, #EF4A25 0%, #ff6b47 100%);
        }
        
        .froala-theme {
            --primary-color: #0098F7;
            --primary-light: #33aaff;
            --primary-rgba: 0, 152, 247;
            --bg-gradient: linear-gradient(135deg, #cce7ff 0%, #e6f3ff 100%);
            --header-gradient: linear-gradient(135deg, #0098F7 0%, #33aaff 100%);
            --button-gradient: linear-gradient(135deg, #0098F7 0%, #33aaff 100%);
            --keyword-gradient: linear-gradient(135deg, #0098F7 0%, #33aaff 100%);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: var(--bg-gradient);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: var(--header-gradient);
            color: white;
            padding: 40px;
            text-align: center;
            transition: background 0.3s ease;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 40px;
        }
        
        .form-section {
            margin-bottom: 40px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        textarea {
            width: 100%;
            min-height: 250px;
            padding: 20px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
            line-height: 1.6;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-rgba), 0.2);
            transition: all 0.3s ease;
        }
        
        textarea::placeholder {
            color: #95a5a6;
            line-height: 1.6;
        }
        
        .source-selection {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .radio-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border: 2px solid #e1e8ed;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .radio-group:hover {
            border-color: var(--primary-color);
            background: rgba(var(--primary-rgba), 0.05);
            transition: all 0.3s ease;
        }
        
        .radio-group input[type="radio"] {
            margin: 0;
        }
        
        .radio-group.selected {
            border-color: var(--primary-color);
            background: rgba(var(--primary-rgba), 0.1);
            transition: all 0.3s ease;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        button {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--button-gradient);
            color: white;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(var(--primary-rgba), 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .loading {
            display: none;
            color: var(--primary-color);
            font-style: italic;
            font-weight: 500;
            transition: color 0.3s ease;
        }
        
        .loading.show {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e1e8ed;
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            display: none;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .results.show {
            display: block;
        }
        
        .recommendation {
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            font-weight: 600;
            font-size: 18px;
            border-left: 5px solid;
        }
        
        .recommendation.red {
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            color: #c62828;
            border-left-color: #c62828;
        }
        
        .recommendation.orange {
            background: linear-gradient(135deg, #fff3e0 0%, #fce4ec 100%);
            color: #ef6c00;
            border-left-color: #ef6c00;
        }
        
        .recommendation.yellow {
            background: linear-gradient(135deg, #fffde7 0%, #fff8e1 100%);
            color: #f57f17;
            border-left-color: #f57f17;
        }
        
        .recommendation.green {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
            color: #2e7d32;
            border-left-color: #2e7d32;
        }
        
        .recommendation-details {
            font-size: 14px;
            font-weight: 400;
            margin-top: 10px;
            opacity: 0.8;
        }
        
        .keywords-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .keywords-box {
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #e9ecef;
        }
        
        .keywords-box h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .keyword {
            display: inline-block;
            background: var(--keyword-gradient);
            color: white;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.3s ease;
        }
        
        .keyword-count {
            opacity: 0.8;
            font-size: 11px;
        }
        
        .similar-article-title {
            font-size: 13px;
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 500;
            padding: 8px 12px;
            background: rgba(var(--primary-rgba), 0.1);
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
        }
        
        .similar-blogs {
            margin-top: 40px;
        }
        
        .similar-blogs h3 {
            margin-bottom: 25px;
            color: #2c3e50;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .blog-item {
            background: #f8f9fa;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 15px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .blog-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .blog-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            gap: 15px;
        }
        
        .blog-title {
            flex: 1;
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .blog-title a {
            text-decoration: none;
            color: inherit;
            transition: color 0.3s ease;
        }
        
        .blog-title a:hover {
            color: var(--primary-color);
            transition: color 0.3s ease;
        }
        
        .similarity-score {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .similarity-high {
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            color: #c62828;
        }
        
        .similarity-medium {
            background: linear-gradient(135deg, #fff3e0 0%, #fce4ec 100%);
            color: #ef6c00;
        }
        
        .similarity-low {
            background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
            color: #2e7d32;
        }
        
        .blog-description {
            color: #7f8c8d;
            margin-bottom: 15px;
            font-size: 15px;
            line-height: 1.5;
        }
        
        .blog-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .blog-keywords .keyword {
            background: linear-gradient(135deg, #d2b48c 0%, #daa520 100%);
            color: white;
            font-size: 12px;
            padding: 6px 12px;
        }
        
        .error {
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
            color: #c62828;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid #ffcdd2;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        .word-count {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 10px;
        }
        
        .gpt-analysis-detail {
            background: #f0f7f7;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #d0e9e9;
            overflow: hidden;
        }
        
        .analysis-header {
            padding: 20px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            border-bottom: 1px solid #d0e9e9;
        }
        
        .analysis-header:hover {
            background: #e8f4f4;
        }

        .analysis-header h4 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        .toggle-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 14px;
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .expand-icon {
            transition: transform 0.3s ease;
            font-size: 12px;
        }
        
        .analysis-header.expanded .expand-icon {
            transform: rotate(180deg);
        }
        
        .analysis-header.expanded .expand-text::after {
            content: " (click to collapse)";
        }
        
        .gpt-analysis-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .gpt-analysis-content.expanded {
            max-height: none;
            padding: 0 20px 20px 20px;
        }
        
        .gpt-analysis-content.collapsed {
            max-height: 0;
            padding: 0 20px;
        }

        .gpt-analysis-text {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }
        
        .gpt-analysis-text h2, .gpt-analysis-text h3, .gpt-analysis-text h4 {
            color: #2c3e50;
            margin: 20px 0 10px 0;
            font-weight: 600;
        }
        
        .gpt-analysis-text h4 {
            font-size: 16px;
            color: var(--primary-color);
        }
        
        .gpt-analysis-text h3 {
            font-size: 18px;
        }
        
        .gpt-analysis-text h2 {
            font-size: 20px;
        }
        
        .gpt-analysis-text ul, .gpt-analysis-text ol {
            margin: 15px 0;
            padding-left: 25px;
        }
        
        .gpt-analysis-text ol {
            list-style-type: decimal;
        }
        
        .gpt-analysis-text ul {
            list-style-type: disc;
        }
        
        .gpt-analysis-text li {
            margin: 8px 0;
            line-height: 1.5;
        }
        
        .gpt-analysis-text p {
            margin: 10px 0;
        }
        
        .gpt-analysis-text strong {
            color: #2c3e50;
        }
        
        .gpt-analysis-text code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
        }
        
        .gpt-analysis-text pre {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
        }
        
        .gpt-analysis-text pre code {
            background: none;
            padding: 0;
        }
        
        .analysis-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            border: 1px solid #d0e9e9;
        }
        
        .similarity-badge {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.85em;
        }
        
        .length-info {
            color: #555;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .similarity-metrics {
            margin-top: 20px;
            border-top: 1px dashed #e0e0e0;
            padding-top: 20px;
        }

        .cosine-similarity {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            text-align: center;
        }

        .cosine-similarity h4 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .similarity-score-large {
            font-size: 24px;
            font-weight: 700;
            padding: 15px 25px;
            border-radius: 25px;
            margin: 10px 0;
            display: inline-block;
            min-width: 200px;
        }

        .similarity-explanation {
            font-size: 13px;
            color: #7f8c8d;
            font-style: italic;
            margin-top: 10px;
        }
        
        .step-time {
            font-size: 12px;
            color: #7f8c8d;
            margin-left: 10px;
        }
        
        .progress-steps {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #f0f7f7;
            border-radius: 10px;
            border: 1px solid #d0e9e9;
        }
        
        .progress-steps.show {
            display: block;
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .step-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        .step-icon.pending {
            background-color: #e0e0e0;
            color: #555;
        }
        
        .step-icon.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .step-icon.completed {
            background-color: #4CAF50;
            color: white;
        }
        
        .step-text {
            font-size: 14px;
            color: #333;
        }
        
        .step-text.active {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .step-text.completed {
            color: #2e7d32;
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .main-content {
                padding: 30px 20px;
            }
            
            .keywords-section {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: stretch;
            }
            
            button {
                justify-content: center;
            }
            
            .source-selection {
                flex-direction: column;
                align-items: stretch;
            }
            
            .blog-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .similarity-score {
                align-self: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìù Blog Similarity Checker</h1>
            <p>Check if your draft content is too similar to existing blog posts using AI-powered semantic analysis</p>
        </div>
        
        <div class="main-content">
            <div class="form-section">
                <div class="form-group">
                    <label for="draftText">üìÑ Paste your draft blog content:</label>
                    <textarea 
                        id="draftText" 
                        placeholder="Paste your blog draft here...

Example:
'How to build a modern rich text editor for web applications. Rich text editors are essential components that allow users to format text with bold, italic, links, and other styling options. In this guide, we'll explore the key considerations when building or choosing a rich text editor...'

Minimum 50 characters required for analysis."
                        oninput="updateWordCount()"
                    ></textarea>
                    <div id="wordCount" class="word-count">0 characters</div>
                </div>
                
                <div class="form-group">
                    <label>üéØ Check against which blog source:</label>
                    <div class="source-selection">
                        <div class="radio-group selected" onclick="selectSource('filestack')">
                            <input type="radio" id="filestack" name="source" value="filestack" checked>
                            <label for="filestack">üìö Filestack Blogs</label>
                        </div>
                        <div class="radio-group" onclick="selectSource('froala')">
                            <input type="radio" id="froala" name="source" value="froala">
                            <label for="froala">‚ú® Froala Blogs</label>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button id="checkSimilarity" class="btn-primary" onclick="checkSimilarity()">
                        üîç Check Similarity
                    </button>
                                         <div id="loading" class="loading">
                         <div class="spinner"></div>
                         <span>Analyzing similarity with AI...</span>
                     </div>
                     
                     <div id="progressSteps" class="progress-steps">
                         <div class="progress-step" id="step1">
                             <div class="step-icon pending">1</div>
                             <div class="step-text">Generating embeddings for your draft</div>
                             <div class="step-time"></div>
                         </div>
                         <div class="progress-step" id="step2">
                             <div class="step-icon pending">2</div>
                             <div class="step-text">Searching vector database for similar content</div>
                             <div class="step-time"></div>
                         </div>
                         <div class="progress-step" id="step3">
                             <div class="step-icon pending">3</div>
                             <div class="step-text">Analyzing content with GPT-4o-mini</div>
                             <div class="step-time"></div>
                         </div>
                         <div class="progress-step" id="step4">
                             <div class="step-icon pending">4</div>
                             <div class="step-text">Preparing results</div>
                             <div class="step-time"></div>
                         </div>
                     </div>
                 </div>
            </div>
            
            <div id="error" class="error"></div>
            
            <div id="results" class="results">
                <div id="recommendation" class="recommendation"></div>
                
                <div class="keywords-section">
                    <div class="keywords-box">
                        <h3>üéØ Your Draft Keywords</h3>
                        <div id="draftKeywords"></div>
                    </div>
                    <div class="keywords-box">
                        <h3>üìö Top Similar Article Keywords</h3>
                        <div style="font-size: 12px; color: #666; margin-bottom: 15px; font-style: italic;">
                            Keywords from the most similar article only (not aggregated from all results)
                        </div>
                        <div id="similarArticleTitle" class="similar-article-title"></div>
                        <div id="similarKeywords"></div>
                    </div>
                </div>
                
                <div class="similar-blogs">
                    <h3>üîç Most Similar Blog Posts</h3>
                    <div id="blogsList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let isChecking = false;
        
        // Update word count
        function updateWordCount() {
            const text = document.getElementById('draftText').value;
            const count = text.length;
            document.getElementById('wordCount').textContent = `${count} characters`;
        }
        
        // Handle source selection
        function selectSource(source) {
            // Update radio buttons
            document.getElementById('filestack').checked = (source === 'filestack');
            document.getElementById('froala').checked = (source === 'froala');
            
            // Update visual selection
            document.querySelectorAll('.radio-group').forEach(group => {
                group.classList.remove('selected');
            });
            event.target.closest('.radio-group').classList.add('selected');
            
            // Update theme based on source
            updateTheme(source);
        }
        
        // Update theme colors based on selected source
        function updateTheme(source) {
            const body = document.body;
            if (source === 'froala') {
                body.classList.add('froala-theme');
            } else {
                body.classList.remove('froala-theme');
            }
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }
        
        // Hide error message
        function hideError() {
            document.getElementById('error').classList.remove('show');
        }
        
        // Enhanced markdown renderer for GPT analysis - optimized for less whitespace
        function renderMarkdown(text) {
            if (!text) return '';
            
            // Cache the result to avoid reprocessing
            const cacheKey = `markdown_${text.length}_${text.substring(0, 100)}`;
            if (renderMarkdown.cache && renderMarkdown.cache[cacheKey]) {
                return renderMarkdown.cache[cacheKey];
            }
            
            // Initialize cache if not exists
            if (!renderMarkdown.cache) renderMarkdown.cache = {};
            
            let result = text
                .trim() // Remove leading/trailing whitespace
                .replace(/\n{3,}/g, '\n\n') // Reduce multiple line breaks to max 2
                .replace(/^\s+/gm, ''); // Remove leading whitespace from each line
            
            // Process headers first (with proper escaping)
            result = result
                .replace(/^#### (.*$)/gm, '<h4>$1</h4>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>');
            
            // Process numbered lists (1. 2. 3. etc)
            result = result.replace(/^\d+\.\s+(.+)$/gm, '<li class="numbered-item">$1</li>');
            
            // Process bullet points (- * + at start of line)
            result = result.replace(/^[-*+]\s+(.+)$/gm, '<li class="bullet-item">$1</li>');
            
            // Wrap consecutive list items in proper list containers
            result = result.replace(/(<li class="numbered-item">.*?<\/li>(?:\s*<li class="numbered-item">.*?<\/li>)*)/gs, '<ol>$1</ol>');
            result = result.replace(/(<li class="bullet-item">.*?<\/li>(?:\s*<li class="bullet-item">.*?<\/li>)*)/gs, '<ul>$1</ul>');
            
            // Clean up list classes after wrapping
            result = result.replace(/class="numbered-item"/g, '').replace(/class="bullet-item"/g, '');
            
            // Process bold and italic text
            result = result
                .replace(/\*\*((?:(?!\*\*).)*)\*\*/g, '<strong>$1</strong>')
                .replace(/(?<!\*)\*([^*\n]+)\*(?!\*)/g, '<em>$1</em>');
            
            // Process code blocks and inline code
            result = result.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            result = result.replace(/`([^`\n]+)`/g, '<code>$1</code>');
            
            // Split into paragraphs based on double line breaks, but be more conservative
            const paragraphs = result.split(/\n\n+/).filter(p => p.trim());
            
            // Process each paragraph
            result = paragraphs.map(paragraph => {
                paragraph = paragraph.trim().replace(/\n/g, ' '); // Single line breaks become spaces
                
                // Don't wrap headers, lists, or code blocks in paragraphs
                if (paragraph.match(/^<[h1-6]|^<[uo]l|^<pre>/)) {
                    return paragraph;
                }
                
                // Wrap other content in paragraphs
                return paragraph ? `<p>${paragraph}</p>` : '';
            }).filter(p => p).join('');
            
            // Clean up any remaining issues
            result = result
                .replace(/<p><\/p>/g, '') // Remove empty paragraphs
                .replace(/<p>(<[h1-6])/g, '$1') // Headers shouldn't be in paragraphs
                .replace(/(<\/[h1-6]>)<\/p>/g, '$1')
                .replace(/<p>(<[uo]l)/g, '$1') // Lists shouldn't be in paragraphs
                .replace(/(<\/[uo]l>)<\/p>/g, '$1')
                .replace(/<p>(<pre>)/g, '$1') // Code blocks shouldn't be in paragraphs
                .replace(/(<\/pre>)<\/p>/g, '$1');
            
            // Cache the result
            renderMarkdown.cache[cacheKey] = result;
            
            // Limit cache size
            const cacheKeys = Object.keys(renderMarkdown.cache);
            if (cacheKeys.length > 50) {
                delete renderMarkdown.cache[cacheKeys[0]];
            }
            
            return result;
        }
        
        // Show loading state
        function showLoading() {
            document.getElementById('loading').classList.add('show');
            document.getElementById('checkSimilarity').disabled = true;
            document.getElementById('results').classList.remove('show');
            isChecking = true;
        }
        
                 // Hide loading state
         function hideLoading() {
             document.getElementById('loading').classList.remove('show');
             document.getElementById('checkSimilarity').disabled = false;
             isChecking = false;
         }
         
         // Progress tracking functions
         function showProgressSteps() {
             document.getElementById('progressSteps').classList.add('show');
         }
         
         function hideProgressSteps() {
             document.getElementById('progressSteps').classList.remove('show');
         }
         
         function updateProgressStep(stepNumber, status, time = '') {
             const step = document.getElementById(`step${stepNumber}`);
             if (!step) return;
             
             const icon = step.querySelector('.step-icon');
             const text = step.querySelector('.step-text');
             const timeEl = step.querySelector('.step-time');
             
             // Remove all status classes
             icon.classList.remove('pending', 'active', 'completed');
             text.classList.remove('active', 'completed');
             
             // Add new status class
             icon.classList.add(status);
             if (status === 'active' || status === 'completed') {
                 text.classList.add(status);
             }
             
             // Update time if provided
             if (time) {
                 timeEl.textContent = time;
             }
         }
         
         function startProgressTracking() {
             showProgressSteps();
             
             // Step 1: Generating embeddings
             updateProgressStep(1, 'active');
             
             // Simulate progress updates (these will be replaced by real progress from Apps Script)
             setTimeout(() => {
                 updateProgressStep(1, 'completed', '‚úì');
                 updateProgressStep(2, 'active');
             }, 2000);
             
             setTimeout(() => {
                 updateProgressStep(2, 'completed', '‚úì');
                 updateProgressStep(3, 'active');
             }, 4000);
             
             setTimeout(() => {
                 updateProgressStep(3, 'completed', '‚úì');
                 updateProgressStep(4, 'active');
             }, 6000);
         }
        
        // Display results with detailed timing
        function displayResults(data) {
            console.log('üìä Starting displayResults with data:', data);
            
            // Basic elements timing
            const basicStart = performance.now();
            
            // Display recommendation
            const recommendation = document.getElementById('recommendation');
            const rec = data.recommendations;
            
            let recommendationHTML = `<div>${rec.message}</div>`;
            if (rec.details) {
                recommendationHTML += `<div class="recommendation-details">${rec.details}</div>`;
            }
            
            recommendation.innerHTML = recommendationHTML;
            recommendation.className = `recommendation ${rec.color}`;
            
            // Display draft keywords
            const draftKeywords = document.getElementById('draftKeywords');
            draftKeywords.innerHTML = data.draftKeywords
                .slice(0, 10)
                .map(([word, count]) => `<span class="keyword">${word} <span class="keyword-count">(${count})</span></span>`)
                .join('');
            
            // Display similar articles keywords (from top article only)
            const similarKeywords = document.getElementById('similarKeywords');
            const similarArticleTitle = document.getElementById('similarArticleTitle');
            
            if (data.similarKeywords && data.similarKeywords.length > 0 && data.similarBlogs && data.similarBlogs.length > 0) {
                // Show which article the keywords are from
                const topArticle = data.similarBlogs[0];
                similarArticleTitle.innerHTML = `üìÑ <strong>"${topArticle.title}"</strong> <span style="color: var(--primary-color); font-size: 12px;">(${topArticle.similarity}% similar)</span>`;
                
                similarKeywords.innerHTML = data.similarKeywords
                    .slice(0, 10)
                    .map(([word, count]) => `<span class="keyword">${word} <span class="keyword-count">(${count})</span></span>`)
                    .join('');
            } else {
                similarArticleTitle.innerHTML = '';
                similarKeywords.innerHTML = '<span style="color: #666; font-style: italic;">No similar articles found</span>';
            }
                
            console.log(`‚ö° Basic elements rendered: ${(performance.now() - basicStart).toFixed(2)}ms`);
            
            // Blog list timing
            const blogStart = performance.now();
            const blogsList = document.getElementById('blogsList');
            const draftText = document.getElementById('draftText').value.trim();
            
            console.log(`üìù Processing ${data.similarBlogs.length} blogs...`);
            
            // Truncate content for better performance
            const truncateText = (text, maxLength = 1000) => {
                if (!text || text.length <= maxLength) return text || 'Content not available';
                return text.substring(0, maxLength) + '... <em>(content truncated for performance)</em>';
            };
            
            const truncatedDraft = truncateText(draftText);
            
            // Build HTML with timing for each blog
            const htmlParts = [];
            data.similarBlogs.forEach((blog, index) => {
                const blogItemStart = performance.now();
                
                const similarity = parseFloat(blog.similarity);
                const similarityClass = similarity >= 70 ? 'similarity-high' : 
                                      similarity >= 50 ? 'similarity-medium' : 'similarity-low';
                
                const keywords = blog.keywords || [];
                const isTopThree = index < 3; // Only first 3 blogs get GPT analysis
                const gptAnalysis = data.gptAnalyses && data.gptAnalyses[index] ? data.gptAnalyses[index] : null;
                const truncatedBlogContent = truncateText(blog.content);
                
                // Render GPT analysis with timing - ONLY for top 3
                let gptAnalysisHTML = '';
                if (isTopThree && gptAnalysis) {
                    const markdownStart = performance.now();
                    const renderedAnalysis = renderMarkdown(gptAnalysis.analysis);
                    console.log(`ü§ñ Blog ${index + 1} markdown rendered: ${(performance.now() - markdownStart).toFixed(2)}ms`);
                    
                    gptAnalysisHTML = `
                        <div class="gpt-analysis-detail">
                            <div class="analysis-header" onclick="toggleAnalysis(${index})">
                                <h4>üß† AI Analysis for "${gptAnalysis.blogTitle}"</h4>
                                <div class="analysis-meta">
                                    <span class="similarity-badge">${gptAnalysis.similarity}% similar</span>
                                    <span class="length-info">Draft: ${gptAnalysis.draftLength.toLocaleString()} chars | Blog: ${gptAnalysis.contentLength.toLocaleString()} chars</span>
                                </div>
                                <div class="toggle-btn">
                                    <span class="expand-icon">‚ñº</span>
                                    <span class="expand-text">Click to view detailed analysis</span>
                                </div>
                            </div>
                            <div class="gpt-analysis-content collapsed" id="analysis-${index}">
                                <div class="gpt-analysis-text">${renderedAnalysis}</div>
                            </div>
                        </div>
                    `;
                } else if (!isTopThree) {
                    // For blogs 4-10: Show a simplified note about why no AI analysis
                    gptAnalysisHTML = `
                        <div class="similarity-note">
                            <div class="note-content">
                                <span class="note-icon">‚ÑπÔ∏è</span>
                                <span class="note-text">Detailed AI analysis is available for the top 3 most similar blogs only</span>
                                <span class="ranking-badge">Ranked #${index + 1}</span>
                            </div>
                        </div>
                    `;
                }
                
                htmlParts.push(`
                    <div class="blog-item">
                        <div class="blog-header">
                            <div class="blog-title">
                                <a href="${blog.url}" target="_blank">${blog.title}</a>
                            </div>
                            <div class="similarity-score ${similarityClass}">${blog.similarity}% similar</div>
                        </div>
                        <div class="blog-description">${blog.description || 'No description available'}</div>
                        
                        ${gptAnalysisHTML}
                        
                        <div class="similarity-metrics">
                            <div class="cosine-similarity">
                                <h4>üîç Vector Similarity Score</h4>
                                <div class="similarity-score-large ${similarityClass}">
                                    ${blog.similarity}% Cosine Similarity
                                </div>
                                <div class="similarity-explanation">
                                    Based on semantic vector analysis of content embeddings
                                </div>
                            </div>
                        </div>
                        
                        <div class="blog-keywords">
                            ${keywords.slice(0, 5).map(([word]) => `<span class="keyword">${word}</span>`).join('')}
                        </div>
                    </div>
                `);
                
                console.log(`üìÑ Blog ${index + 1} processed: ${(performance.now() - blogItemStart).toFixed(2)}ms`);
            });
            
            // Single DOM update
            const domStart = performance.now();
            blogsList.innerHTML = htmlParts.join('');
            console.log(`üèóÔ∏è DOM update: ${(performance.now() - domStart).toFixed(2)}ms`);
            
            console.log(`üìä Blog list total: ${(performance.now() - blogStart).toFixed(2)}ms`);
            
            // Show results
            document.getElementById('results').classList.add('show');
        }
        
        // Performance timing utilities
        const performanceTimer = {
            timers: {},
            start(label) {
                this.timers[label] = performance.now();
                console.log(`‚è±Ô∏è [TIMER START] ${label}`);
            },
            end(label) {
                if (this.timers[label]) {
                    const elapsed = performance.now() - this.timers[label];
                    console.log(`‚è±Ô∏è [TIMER END] ${label}: ${elapsed.toFixed(2)}ms`);
                    delete this.timers[label];
                    return elapsed;
                }
                return 0;
            },
            step(stepNumber, label, elapsed) {
                updateProgressStep(stepNumber, 'completed', `${elapsed.toFixed(0)}ms`);
            }
        };

        // Main similarity check function
        async function checkSimilarity() {
            const draftText = document.getElementById('draftText').value.trim();
            const source = document.querySelector('input[name="source"]:checked')?.value;
            
            if (!draftText) {
                showError('Please enter your draft content.');
                return;
            }
            
            if (!source) {
                showError('Please select a content source.');
                return;
            }
            
            if (isChecking) {
                return; // Prevent multiple simultaneous requests
            }
            
            performanceTimer.start('TOTAL_PROCESS');
            hideError();
            showLoading();
            startProgressTracking(); // Start progress tracking
            
            try {
                performanceTimer.start('APPS_SCRIPT_CALL');
                updateProgressStep(1, 'active');
                
                // Call the Apps Script function (which will handle API keys from environment)
                const results = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler((result) => {
                            const elapsed = performanceTimer.end('APPS_SCRIPT_CALL');
                            console.log('‚úÖ Apps Script Success:', result);
                            console.log(`üìä Backend Processing Time: ${elapsed.toFixed(2)}ms`);
                            resolve(result);
                        })
                        .withFailureHandler((error) => {
                            performanceTimer.end('APPS_SCRIPT_CALL');
                            console.error('‚ùå Apps Script Error:', error);
                            reject(new Error(error.message || 'Apps Script execution failed'));
                        })
                        .processSimilarityCheck(draftText, source);
                });
                
                performanceTimer.start('FRONTEND_PROCESSING');
                updateProgressStep(4, 'active');
                
                if (results && results.error) {
                    showError(results.error);
                } else if (results) {
                    performanceTimer.start('DISPLAY_RESULTS');
                    displayResults(results);
                    const displayElapsed = performanceTimer.end('DISPLAY_RESULTS');
                    performanceTimer.step(4, 'Preparing results', displayElapsed);
                    console.log(`üé® Results Display Time: ${displayElapsed.toFixed(2)}ms`);
                } else {
                    showError('No results received from similarity check');
                }
                
                const frontendElapsed = performanceTimer.end('FRONTEND_PROCESSING');
                console.log(`‚ö° Frontend Processing Time: ${frontendElapsed.toFixed(2)}ms`);
                
            } catch (error) {
                console.error('Error:', error);
                
                // Better error handling for common Apps Script issues
                let errorMessage = 'Something went wrong. Please try again.';
                
                if (error.message.includes('Script function not found')) {
                    errorMessage = 'Apps Script function not found. Please check your code.';
                } else if (error.message.includes('Authorization required')) {
                    errorMessage = 'Authorization required. Please refresh and try again.';
                } else if (error.message.includes('API')) {
                    errorMessage = 'API error. Please check your API keys in Apps Script environment variables.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showError(`Error: ${errorMessage}`);
            } finally {
                const totalElapsed = performanceTimer.end('TOTAL_PROCESS');
                console.log(`üèÅ TOTAL PROCESS TIME: ${totalElapsed.toFixed(2)}ms`);
                hideLoading();
                hideProgressSteps();
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+Enter to check similarity
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                checkSimilarity();
            }
        });
        
        // Initialize
        updateWordCount();
        
        // Set initial theme based on default selection
        updateTheme('filestack');
        
        // Focus on textarea when page loads
        document.getElementById('draftText').focus();
        
        // Toggle analysis sections
        function toggleAnalysis(index) {
            const analysisContent = document.getElementById(`analysis-${index}`);
            const header = analysisContent.previousElementSibling;
            
            if (analysisContent.classList.contains('collapsed')) {
                analysisContent.classList.remove('collapsed');
                analysisContent.classList.add('expanded');
                header.classList.add('expanded');
                
                // Smooth expand animation
                analysisContent.style.maxHeight = analysisContent.scrollHeight + 'px';
                
                // Update text
                const expandText = header.querySelector('.expand-text');
                expandText.textContent = 'Click to collapse detailed analysis';
            } else {
                analysisContent.classList.remove('expanded');
                analysisContent.classList.add('collapsed');
                header.classList.remove('expanded');
                
                // Smooth collapse animation
                analysisContent.style.maxHeight = '0px';
                
                // Update text
                const expandText = header.querySelector('.expand-text');
                expandText.textContent = 'Click to view detailed analysis';
            }
        }
        
        function toggleSimilarityView(blogIndex) {
            const blogItem = document.querySelectorAll('.blog-item')[blogIndex];
            const contentComparison = blogItem.querySelector('.content-comparison');
            const toggleBtn = blogItem.querySelector('.toggle-btn');
            
            if (contentComparison.style.display === 'none') {
                contentComparison.style.display = 'flex';
                toggleBtn.textContent = 'üîç Hide Content Comparison';
            } else {
                contentComparison.style.display = 'none';
                toggleBtn.textContent = 'üîç Show Content Comparison';
            }
        }
    </script>
</body>
</html>